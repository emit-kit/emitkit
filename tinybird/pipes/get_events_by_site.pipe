DESCRIPTION >
    Get aggregated event statistics by site.
    Automatically enforces retention policy based on event's retention_tier.
    Useful for site-level analytics dashboards.
    Hierarchy: organization -> site -> channel -> event

TOKEN "dashboard" READ

NODE site_events
SQL >
    %
    SELECT
        site_id,
        count() as event_count,
        uniq(user_id) as unique_users,
        uniq(channel_id) as channel_count,
        min(created_at) as first_event,
        max(created_at) as last_event
    FROM events
    WHERE
        organization_id = {{ String(organization_id, required=True) }}
        -- Retention filtering based on tier (no JOIN!)
        AND (
            (retention_tier = 'basic' AND created_at >= now() - INTERVAL 90 DAY)
            OR (retention_tier = 'premium' AND created_at >= now() - INTERVAL 365 DAY)
            OR retention_tier = 'unlimited'
        )
        {% if defined(site_id) %}
            AND site_id = {{ String(site_id) }}
        {% end %}
        {% if defined(date_from) %}
            AND created_at >= {{ DateTime(date_from) }}
        {% end %}
        {% if defined(date_to) %}
            AND created_at <= {{ DateTime(date_to) }}
        {% end %}
    GROUP BY site_id
    ORDER BY event_count DESC

TYPE endpoint
